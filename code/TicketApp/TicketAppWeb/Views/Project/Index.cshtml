@model ProjectViewModel
@{
    ViewData["Title"] = "Project Management";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap">
<link href="~/css/projectmanagement.css" rel="stylesheet" />

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2 class="text-center">Project Management</h2>
            <div class="title-divider"></div>
            <br />
            <br/>

            <!-- Filter Options -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <input type="text" id="projectSearch" class="form-control" placeholder="Search by project name">
                </div>
                <div class="col-md-4">
                    <select id="groupFilter" class="form-select">
                        <option value="">Filter by Group</option>
                        @foreach (var group in Model.AvailableGroups)
                        {
                            <option value="@group.Id">@group.GroupName</option>
                        }
                    </select>
                </div>
            </div>

            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addProjectModal">Add Project</button>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Project Name</th>
                        <th>Assigned Groups</th>
                        <th>Project Lead</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var project in Model.Projects)
                    {
                        <tr>
                            <td>@project.ProjectName</td>
                            <td>
                                @foreach (var group in project.Groups)
                                {
                                    <a href="@Url.Action("Details", "Group", new { id = group.Id })" class="badge bg-info text-dark">@group.GroupName</a>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(project.LeadId))
                                {
                                    <a href="@Url.Action("Details", "User", new { id = project.LeadId })">@project.Lead!.FullName</a>
                                }
                            </td>
                            <td>
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editProjectModal" onclick="loadProjectData('@project.Id')">Edit</button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal" onclick="confirmDelete('@project.Id')">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProjectForm" asp-action="Add" asp-controller="Project" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Project Name</label>
                        <input asp-for="Project.ProjectName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign Groups</label>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Available Groups</h6>
                                <ul id="availableGroups" class="list-group">
                                    @foreach (var group in Model.AvailableGroups)
                                    {
                                        <li class="list-group-item">
                                            <input type="checkbox" class="group-checkbox" value="@group.Id" />
                                            @group.GroupName
                                        </li>
                                    }
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Assigned Groups</h6>
                                <ul id="assignedGroups" class="list-group">
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Project Lead</label>
                        <select id="projectLead" asp-for="ProjectLeadId" class="form-select">
                            <option value="">Select a Lead</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const availableGroups = document.getElementById("availableGroups");
        const assignedGroups = document.getElementById("assignedGroups");
        const projectLeadSelect = document.getElementById("projectLead");

        availableGroups.addEventListener("change", function (event) {
            if (event.target.classList.contains("group-checkbox")) {
                if (event.target.checked) {
                    let listItem = document.createElement("li");
                    listItem.className = "list-group-item";
                    listItem.textContent = event.target.parentNode.textContent.trim();
                    listItem.setAttribute("data-group-id", event.target.value);
                    assignedGroups.appendChild(listItem);
                } else {
                    let items = assignedGroups.querySelectorAll(".list-group-item");
                    items.forEach(item => {
                        if (item.getAttribute("data-group-id") === event.target.value) {
                            assignedGroups.removeChild(item);
                        }
                    });
                }
                updateProjectLeads();
            }
        });

        function updateProjectLeads() {
            projectLeadSelect.innerHTML = '<option value="">Select a Lead</option>';
            let selectedGroupIds = Array.from(assignedGroups.children)
                .map(item => item.getAttribute("data-group-id"));

            if (selectedGroupIds.length === 0) {
                return;
            }

            fetch(`/Project/GetGroupLeads?groupIds=${selectedGroupIds.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        console.warn("No leads found for the selected groups.");
                    }

                    data.forEach(lead => {
                        let option = document.createElement("option");
                        option.value = lead.id;
                        option.textContent = lead.fullName;
                        projectLeadSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching leads:", error));
        }
    });
</script>
